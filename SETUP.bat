@echo off
chcp 65001 >nul
title –ü–û–õ–ù–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê –¢–û–† - –°–µ—Ä–≤–µ—Ä
cd /d "%~dp0"

echo ============================================================
echo   üöÄ –ü–û–õ–ù–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê –ü–†–û–ï–ö–¢–ê –¢–û–†
echo   –¢–≤–æ—Ä—á–µ—Å–∫–∏–π –û–ª–∏–º–ø–∏–π—Å–∫–∏–π –†–∞–∑—É–º
echo ============================================================
echo.

REM ============================================================
REM –®–ê–ì 1: –ü–†–û–í–ï–†–ö–ê PYTHON
REM ============================================================
echo [1/7] üêç –ü—Ä–æ–≤–µ—Ä–∫–∞ Python...
python --version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå Python –Ω–µ –Ω–∞–π–¥–µ–Ω!
    echo üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.8+ —Å python.org
    pause
    exit /b 1
)
for /f "tokens=2" %%i in ('python --version 2^>^&1') do set PYTHON_VER=%%i
echo ‚úÖ Python %PYTHON_VER% –Ω–∞–π–¥–µ–Ω
echo.

REM ============================================================
REM –®–ê–ì 2: –°–û–ó–î–ê–ù–ò–ï –í–ò–†–¢–£–ê–õ–¨–ù–û–ì–û –û–ö–†–£–ñ–ï–ù–ò–Ø
REM ============================================================
echo [2/7] üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...
if exist "venv\" (
    echo ‚ö†Ô∏è  venv —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞—é...
) else (
    python -m venv venv
    if errorlevel 1 (
        echo ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è venv
        pause
        exit /b 1
    )
    echo ‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ
)
echo.

REM ============================================================
REM –®–ê–ì 3: –ê–ö–¢–ò–í–ê–¶–ò–Ø –û–ö–†–£–ñ–ï–ù–ò–Ø
REM ============================================================
echo [3/7] üîÑ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...
call venv\Scripts\activate
if errorlevel 1 (
    echo ‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
    pause
    exit /b 1
)
echo ‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ
echo.

REM ============================================================
REM –®–ê–ì 4: –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
REM ============================================================
echo [4/7] üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...
echo ‚è≥ –≠—Ç–æ –∑–∞–π–º—ë—Ç 5-15 –º–∏–Ω—É—Ç (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ ~2GB)
echo.

REM –û–±–Ω–æ–≤–ª—è–µ–º pip
echo üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip...
python -m pip install --upgrade pip --quiet

REM –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤...
pip install aiogram aiosqlite python-dotenv requests --quiet
if errorlevel 1 (
    echo ‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
    pause
    exit /b 1
)
echo ‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

REM –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º RAG –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ RAG —Å–∏—Å—Ç–µ–º—ã...
pip install langchain langchain-community langchain-text-splitters langchain-chroma sentence-transformers pypdf docx2txt --quiet
if errorlevel 1 (
    echo ‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ RAG
    pause
    exit /b 1
)
echo ‚úÖ RAG —Å–∏—Å—Ç–µ–º–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
echo.

REM ============================================================
REM –®–ê–ì 5: –°–û–ó–î–ê–ù–ò–ï .ENV
REM ============================================================
echo [5/7] üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...
if not exist ".env" (
    echo # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞ > .env
    echo TELEGRAM_BOT_TOKEN=–í–ê–®_–¢–û–ö–ï–ù_TELEGRAM_–ë–û–¢–ê >> .env
    echo OLLAMA_URL=http://localhost:11434/api/generate >> .env
    echo DEFAULT_MODEL=qwen2.5:7b-instruct-q4_K_M >> .env
    echo DEEP_MODEL=mistral:7b-instruct-q4_K_M >> .env
    echo MAX_STREAM_TIMEOUT=600 >> .env
    echo.
    echo ‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª .env
    echo ‚ö†Ô∏è  –í–ê–ñ–ù–û: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞!
) else (
    echo ‚úÖ –§–∞–π–ª .env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
)
echo.

REM ============================================================
REM –®–ê–ì 6: –°–û–ó–î–ê–ù–ò–ï –ü–ê–ü–û–ö
REM ============================================================
echo [6/7] üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–ø–æ–∫...
if not exist "documents\" (
    mkdir documents
    echo ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ documents\
) else (
    echo ‚úÖ –ü–∞–ø–∫–∞ documents\ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
)

if not exist "data\" (
    mkdir data
    echo ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ data\
) else (
    echo ‚úÖ –ü–∞–ø–∫–∞ data\ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
)
echo.

REM ============================================================
REM –®–ê–ì 7: –ü–†–û–í–ï–†–ö–ê OLLAMA
REM ============================================================
echo [7/7] ü§ñ –ü—Ä–æ–≤–µ—Ä–∫–∞ Ollama...
curl -s http://localhost:11434/api/tags >nul 2>&1
if errorlevel 1 (
    echo ‚ö†Ô∏è  Ollama –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞ –∏–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    echo.
    echo üí° –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨:
    echo    1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Ollama —Å https://ollama.ai
    echo    2. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤–æ–µ –æ–∫–Ω–æ CMD –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: ollama serve
    echo    3. –°–∫–∞—á–∞–π—Ç–µ –º–æ–¥–µ–ª–∏:
    echo       ollama pull qwen2.5:7b-instruct-q4_K_M
    echo       ollama pull mistral:7b-instruct-q4_K_M
    echo.
) else (
    echo ‚úÖ Ollama –¥–æ—Å—Ç—É–ø–Ω–∞
    
    REM –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥–µ–ª–∏
    curl -s http://localhost:11434/api/tags > temp_models.json
    findstr /C:"qwen2.5" temp_models.json >nul
    if errorlevel 1 (
        echo ‚ö†Ô∏è  –ú–æ–¥–µ–ª—å qwen2.5 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
        echo üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: ollama pull qwen2.5:7b-instruct-q4_K_M
    ) else (
        echo ‚úÖ qwen2.5 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    )
    
    findstr /C:"mistral" temp_models.json >nul
    if errorlevel 1 (
        echo ‚ö†Ô∏è  –ú–æ–¥–µ–ª—å mistral –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
        echo üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: ollama pull mistral:7b-instruct-q4_K_M
    ) else (
        echo ‚úÖ mistral —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    )
    del temp_models.json >nul 2>&1
)
echo.

REM ============================================================
REM –ò–¢–û–ì–ò –£–°–¢–ê–ù–û–í–ö–ò
REM ============================================================
echo ============================================================
echo   ‚úÖ –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!
echo ============================================================
echo.
echo üìã –ß–¢–û –î–ï–õ–ê–¢–¨ –î–ê–õ–¨–®–ï:
echo.
echo 1Ô∏è‚É£  –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª:
echo    ‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –æ—Ç @BotFather
echo.
echo 2Ô∏è‚É£  –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ RAG —Å–∏—Å—Ç–µ–º–∞:
echo    ‚Ä¢ –ü–æ–ª–æ–∂–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –ø–∞–ø–∫—É documents\
echo    ‚Ä¢ –ó–∞–ø—É—Å—Ç–∏—Ç–µ: 2_load_documents.bat
echo.
echo 3Ô∏è‚É£  –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:
echo    ‚Ä¢ –ó–∞–ø—É—Å—Ç–∏—Ç–µ: 1_run.bat
echo    ‚Ä¢ –í Telegram: /start
echo    ‚Ä¢ –î–ª—è RAG: /rag_init
echo.
echo üìö –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞:
echo    ‚Ä¢ bot.py - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
echo    ‚Ä¢ config.py - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
echo    ‚Ä¢ rag_manager.py - RAG —Å–∏—Å—Ç–µ–º–∞
echo    ‚Ä¢ .env - —Ç–æ–∫–µ–Ω—ã (–°–ï–ö–†–ï–¢–ù–û!)
echo.
echo ‚öôÔ∏è  Ollama –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ñ–æ–Ω–µ!
echo    –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–π CMD –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: ollama serve
echo.
echo ============================================================
pause